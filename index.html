<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Worship Scheduler</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="stylenew.css">
  <style>


    /* Room container styles */
    .room-container {
      margin: 20px auto;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      background: rgba(255,255,255,0.9);
      max-width: 480px;
      position: relative;
      transition: all 0.4s ease;
    }

    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .room-name {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
    }

    .room-activity {
      margin: 8px 0 12px 0;
      font-size: 16px;
      font-weight: 500;
      color: #475569;
    }

    .room-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .fs-btn {
      border: none;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .fs-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    #fullscreenBtn {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 1000;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #fullscreenBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
    }

    #activity {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 32px;
      color: #2c3e50;
      letter-spacing: -0.5px;
      line-height: 1.3;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #clock, .room-clock {
      display: block;
      margin: 0 auto 32px auto;
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      border-radius: 50%;
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
      transition: all 0.4s ease;
      border: 8px solid rgba(255, 255, 255, 0.8);
    }

    #digitalClock, .room-digital {
      font-size: 32px;
      font-weight: 800;
      color: #2c3e50;
      margin-bottom: 16px;
      letter-spacing: 4px;
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      border-radius: 16px;
      padding: 16px 24px;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    #countdown, .room-countdown {
      font-size: 18px;
      font-weight: 600;
      color: #475569;
      background: linear-gradient(135deg, #ecfdf5, #d1fae5);
      border-radius: 12px;
      padding: 16px 24px;
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(34, 197, 94, 0.2);
      transition: all 0.3s ease; /* Smooth transition for updates */
    }

    .status-offline {
      background: linear-gradient(135deg, #fef2f2, #fee2e2) !important;
      color: #dc2626 !important;
      border-color: rgba(220, 38, 38, 0.2) !important;
    }

    /* FULLSCREEN STYLES FOR INDIVIDUAL ROOMS */
    .room-fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .room-fullscreen-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .room-fullscreen-content {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 0 20px;
      margin: 0 auto;
      max-height: 100vh;
      overflow: hidden;
    }
    
    .room-fullscreen-content .room-name {
      font-size: clamp(20px, 3.5vw, 28px) !important;
      color: white !important;
      margin-bottom: 15px !important;
      line-height: 1.2;
      max-width: 90%;
    }

    .room-fullscreen-content .room-activity {
      font-size: clamp(24px, 4.5vw, 36px) !important;
      margin-bottom: 25px !important;
      color: white !important;
      background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6) !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
      background-clip: text !important;
      text-shadow: 0 0 15px rgba(255, 255, 255, 0.3) !important;
      line-height: 1.2;
      max-width: 90%;
      font-weight: 700;
    }

    .room-fullscreen-content .room-clock {
      width: min(65vw, 55vh) !important;
      height: min(65vw, 55vh) !important;
      margin: 20px auto 25px auto !important;
      background: radial-gradient(circle at 30% 30%, #f8fafc, #cbd5e1) !important;
      border: 10px solid rgba(255, 255, 255, 0.9) !important;
      box-shadow: 
        0 0 30px rgba(255, 255, 255, 0.2),
        inset 0 2px 15px rgba(0, 0, 0, 0.1) !important;
    }

    .room-fullscreen-content .room-digital {
      font-size: clamp(20px, 3.5vw, 32px) !important;
      padding: 15px 25px !important;
      margin: 10px auto 15px auto !important;
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(20px) !important;
      border: 2px solid rgba(255, 255, 255, 0.3) !important;
      letter-spacing: 3px !important;
      min-width: 240px !important;
      max-width: 85%;
      line-height: 1.2;
      font-weight: 700;
    }

    .room-fullscreen-content .room-countdown {
      font-size: clamp(16px, 3vw, 24px) !important;
      padding: 12px 20px !important;
      background: rgba(255, 255, 255, 0.9) !important;
      backdrop-filter: blur(20px) !important;
      border: 2px solid rgba(255, 255, 255, 0.3) !important;
      min-width: 220px !important;
      max-width: 85%;
      line-height: 1.3;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .room-fullscreen-content .room-countdown.status-offline {
      background: rgba(239, 68, 68, 0.9) !important;
      color: white !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
    }

    /* Hide the fullscreen button inside the room when in fullscreen mode */
    .room-container.in-fullscreen-mode .fs-btn {
      display: none !important;
    }

    /* Exit fullscreen button style */
    .exit-fullscreen-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
    }
    
    .exit-fullscreen-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(239, 68, 68, 0.6);
    }

    /* Hide other elements when a room is in fullscreen */
    body.room-fullscreen-active .dashboard {
      visibility: hidden;
      opacity: 0;
      pointer-events: none;
    }

    body.room-fullscreen-active .menu-toggle {
      visibility: hidden;
      opacity: 0;
      pointer-events: none;
    }

    body.room-fullscreen-active #mainContainer {
      visibility: hidden;
      opacity: 0;
      pointer-events: none;
    }

    body.room-fullscreen-active #fullscreenBtn {
      visibility: hidden;
      opacity: 0;
      pointer-events: none;
    }

    body.room-fullscreen-active {
      overflow: hidden !important;
      background: transparent !important;
      padding: 0 !important;
    }

    /* Global fullscreen styles */
    body.fullscreen-mode {
      background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
      overflow: hidden;
      padding: 0;
    }

    .container.fullscreen-mode {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      max-width: 100vw;
      max-height: 100vh;
      margin: 0 !important;
      padding: 0 !important;
      border-radius: 0;
      background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
      backdrop-filter: none;
      box-shadow: none;
      border: none;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 999;
      overflow: hidden;
    }

    .fullscreen-mode #activity {
      font-size: clamp(36px, 5vw, 64px);
      margin-bottom: 40px;
      color: white;
      background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
    }

    .fullscreen-mode #clock {
      width: min(60vw, 60vh);
      height: min(60vw, 60vh);
      margin-bottom: 40px;
      background: radial-gradient(circle at 30% 30%, #f8fafc, #cbd5e1);
      border: 12px solid rgba(255, 255, 255, 0.9);
      box-shadow: 
        0 0 60px rgba(255, 255, 255, 0.2),
        inset 0 2px 20px rgba(0, 0, 0, 0.1);
    }

    .fullscreen-mode #digitalClock {
      font-size: clamp(24px, 4vw, 56px);
      padding: 24px 40px;
      margin-bottom: 24px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      letter-spacing: 5px;
      min-width: 300px;
    }

    .fullscreen-mode #countdown {
      font-size: clamp(18px, 3vw, 30px);
      padding: 20px 32px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      min-width: 300px;
    }

    .fullscreen-mode .status-offline {
      background: rgba(239, 68, 68, 0.9) !important;
      color: white !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .dashboard {
        flex-direction: column;
      }
      
      .sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        height: 100vh;
        width: 280px;
        z-index: 1000;
        transition: left 0.3s ease;
        margin: 0;
        border-radius: 0 20px 20px 0;
      }
      
      .sidebar.active {
        left: 0;
      }
      
      .menu-toggle {
        display: block;
      }
      
      .main-content {
        width: 100%;
        padding-top: 60px;
      }

      .container, .room-container {
        margin: 20px;
        padding: 24px 20px;
        max-width: calc(100vw - 40px);
      }

      #fullscreenBtn {
        top: 16px;
        right: 16px;
        padding: 10px 16px;
        font-size: 12px;
      }

      #activity {
        font-size: 20px;
        margin-bottom: 24px;
      }

      #clock, .room-clock {
        width: 240px;
        height: 240px;
        border-width: 6px;
      }

      #digitalClock, .room-digital {
        font-size: 24px;
        padding: 12px 16px;
        letter-spacing: 2px;
      }

      #countdown, .room-countdown {
        font-size: 16px;
        padding: 12px 16px;
      }

      .room-fullscreen-content .room-clock {
        width: min(80vw, 50vh) !important;
        height: min(80vw, 50vh) !important;
        border-width: 8px;
      }

      .room-fullscreen-content .room-digital {
        min-width: 240px;
        letter-spacing: 3px;
        font-size: clamp(18px, 5vw, 28px) !important;
      }

      .room-fullscreen-content .room-countdown {
        min-width: 200px;
        font-size: clamp(14px, 4vw, 20px) !important;
      }
      
      .room-fullscreen-content .room-name {
        font-size: clamp(18px, 4vw, 24px) !important;
        margin-bottom: 12px !important;
      }
      
      .room-fullscreen-content .room-activity {
        font-size: clamp(20px, 5vw, 30px) !important;
        margin-bottom: 20px !important;
      }
    }

    @media (max-width: 480px) {
      .room-fullscreen-content {
        padding: 10px;
      }
      
      .room-fullscreen-content .room-name {
        font-size: clamp(16px, 4vw, 20px) !important;
        margin-bottom: 10px !important;
      }
      
      .room-fullscreen-content .room-activity {
        font-size: clamp(18px, 6vw, 26px) !important;
        margin-bottom: 18px !important;
      }
      
      .room-fullscreen-content .room-clock {
        width: min(90vw, 45vh) !important;
        height: min(90vw, 45vh) !important;
        margin: 12px auto 20px auto !important;
        border-width: 6px;
      }

      .room-fullscreen-content .room-digital {
        min-width: 200px;
        font-size: clamp(16px, 6vw, 24px) !important;
        padding: 12px 20px !important;
        letter-spacing: 2px !important;
        margin: 8px auto 12px auto !important;
      }

      .room-fullscreen-content .room-countdown {
        min-width: 180px;
        font-size: clamp(14px, 5vw, 18px) !important;
        padding: 10px 16px !important;
        margin: 8px auto 10px auto !important;
      }
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .container > *, .room-container > * {
      animation: fadeInUp 0.6s ease-out;
    }

    .container > *:nth-child(2), .room-container > *:nth-child(2) { animation-delay: 0.1s; }
    .container > *:nth-child(3), .room-container > *:nth-child(3) { animation-delay: 0.2s; }
    .container > *:nth-child(4), .room-container > *:nth-child(4) { animation-delay: 0.3s; }
    .container > *:nth-child(5), .room-container > *:nth-child(5) { animation-delay: 0.4s; }

    /* Clock pulse animation */
    #clock, .room-clock {
      animation: clockPulse 4s ease-in-out infinite;
    }

    @keyframes clockPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .fullscreen-mode #clock,
    .room-fullscreen-content .room-clock {
      animation: clockPulseFullscreen 6s ease-in-out infinite;
    }

    @keyframes clockPulseFullscreen {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.01); }
    }

    @keyframes blinking {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }

    .no-events {
      text-align: center;
      color: #64748b;
      font-style: italic;
      padding: 20px;
    }
  </style>
</head>
<body>
  <!-- Fullscreen Overlay for Room Clocks -->
  <div class="room-fullscreen-overlay" id="roomFullscreenOverlay">
    <div class="room-fullscreen-content" id="roomFullscreenContent">
      <!-- Content will be moved here -->
    </div>
    <button class="exit-fullscreen-btn" id="roomExitBtn">
      <i class="fas fa-times"></i> Exit Fullscreen
    </button>
  </div>

  <div class="dashboard">
    <!-- Mobile Menu Toggle -->
    <button class="menu-toggle" id="menuToggle">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-clock"></i> Smart Clock</h2>
      </div>
      <div class="nav-menu">
        <div class="nav-item">
          <a href="index.html" class="nav-link active">
            <i class="fas fa-home"></i> Live Dashboard
          </a>
        </div>
        <div class="nav-item">
          <a href="start_planning.html" class="nav-link">
            <i class="fas fa-calendar-plus"></i> Schedule Event
          </a>
        </div>
        <div class="nav-item">
          <a href="view_plans.html" class="nav-link">
            <i class="fas fa-calendar-alt"></i> View Events
          </a>
        </div>
        <div class="nav-item">
          <a href="reports.html" class="nav-link">
            <i class="fas fa-chart-bar"></i> Analytics & Reports
          </a>
        </div>
        <div class="nav-item">
          <a href="admin.html" class="nav-link">
            <i class="fas fa-users-cog"></i> Management Panel
          </a>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1><i class="fas fa-clock"></i> Current Activity</h1>
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">AD</div>
          <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
          </button>
        </div>
      </div>

      <button id="fullscreenBtn" class="always-allowed" onclick="toggleFullscreen()">⛶ Fullscreen</button>
      <div class="container" id="mainContainer">
        <h1 id="activity">Activity: --</h1>
        
        <!-- Overtime Warning Indicator -->
        <div id="overtime-indicator" style="display: none; background-color: red; color: white; font-weight: bold; padding: 10px; margin: 10px 0; border-radius: 8px;">
          OVERTIME
        </div>
        
        <div id="rooms"></div>
      </div>
    </div>
  </div>

  <script>
    let isFullscreen = false;
    let currentRoomFullscreen = null;
    let clockIntervals = new Map(); // Track intervals for each clock
    let originalCanvasData = new Map(); // Store original canvas data
    let originalRoomData = new Map(); // Store original room data for restoration

    // Function to properly resize and redraw a canvas
    function resizeAndRedrawCanvas(canvas, newSize) {
      if (!canvas) return;
      
      const canvasId = canvas.id;
      
      // Clear any existing interval for this canvas
      if (clockIntervals.has(canvasId)) {
        clearInterval(clockIntervals.get(canvasId));
      }
      
      // Store original dimensions if not already stored
      if (!originalCanvasData.has(canvasId)) {
        originalCanvasData.set(canvasId, {
          width: canvas.width,
          height: canvas.height
        });
      }
      
      // Set new size
      canvas.width = newSize;
      canvas.height = newSize;
      
      // Force immediate redraw
      const ctx = canvas.getContext('2d');
      const radius = newSize / 2;
      drawClockFace(ctx, canvas, radius);
      
      // Set up interval for continuous updates
      const interval = setInterval(() => {
        drawClockFace(ctx, canvas, radius);
      }, 1000);
      
      clockIntervals.set(canvasId, interval);
    }

    // Global fullscreen toggle for the main container
    function toggleFullscreen() {
      const body = document.body;
      const container = document.getElementById('mainContainer');
      const canvas = document.getElementById('clock');
      const btn = document.getElementById('fullscreenBtn');

      if (!isFullscreen) {
        isFullscreen = true;
        body.classList.add('fullscreen-mode');
        container.classList.add('fullscreen-mode');
        btn.textContent = '⌌ Exit Fullscreen';

        // Resize canvas for fullscreen
        if (canvas) {
          const size = Math.min(window.innerWidth * 0.6, window.innerHeight * 0.6);
          resizeAndRedrawCanvas(canvas, size);
        }

        // Try to enter browser fullscreen
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen().catch(() => {});
        }
      } else {
        exitFullscreenMode();
      }
    }

    // Calculate optimal size for fullscreen clock to fit without scrolling
    function calculateOptimalClockSize() {
      // Get viewport dimensions
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // Calculate available space considering padding and text elements
      // Reserve 30% of height for text elements (name, activity, digital clock, countdown)
      const availableHeight = viewportHeight * 0.7;
      
      // Calculate size based on available space
      let size = Math.min(viewportWidth * 0.65, availableHeight);
      
      // Ensure it's not too large
      size = Math.min(size, 600);
      
      // Ensure it's not too small
      size = Math.max(size, 200);
      
      return size;
    }

    // Individual room fullscreen toggle - FIXED VERSION (Move elements instead of cloning)
    function toggleRoomFullscreen(roomId) {
      const roomElement = document.getElementById(roomId);
      if (!roomElement) return;

      const overlay = document.getElementById('roomFullscreenOverlay');
      const content = document.getElementById('roomFullscreenContent');
      const exitBtn = document.getElementById('roomExitBtn');
      
      // If we're already in fullscreen for this room, exit
      if (currentRoomFullscreen === roomId && overlay.classList.contains('active')) {
        exitRoomFullscreen();
        return;
      }
      
      // If another room is in fullscreen, exit it first
      if (currentRoomFullscreen && currentRoomFullscreen !== roomId) {
        exitRoomFullscreen();
      }
      
      // Store original parent and next sibling for restoration
      originalRoomData.set(roomId, {
        parent: roomElement.parentNode,
        nextSibling: roomElement.nextSibling,
        originalButton: roomElement.querySelector('.fs-btn').cloneNode(true)
      });
      
      // Hide the fullscreen button inside the room container
      const roomButton = roomElement.querySelector('.fs-btn');
      if (roomButton) {
        roomButton.style.display = 'none';
      }
      
      // Add class to hide the button via CSS
      roomElement.classList.add('in-fullscreen-mode');
      
      // Move the entire room element to the fullscreen overlay
      content.innerHTML = ''; // Clear previous content
      content.appendChild(roomElement);
      
      // Apply fullscreen styling to the room container
      roomElement.style.position = 'relative';
      roomElement.style.width = '100%';
      roomElement.style.maxWidth = 'none';
      roomElement.style.margin = '0';
      roomElement.style.padding = '0';
      roomElement.style.background = 'transparent';
      roomElement.style.border = 'none';
      roomElement.style.boxShadow = 'none';
      
      // Update styles for fullscreen
      const roomName = roomElement.querySelector('.room-name');
      const roomActivity = roomElement.querySelector('.room-activity');
      const canvas = roomElement.querySelector('canvas');
      const digitalClock = roomElement.querySelector('.room-digital');
      const countdown = roomElement.querySelector('.room-countdown');
      
      if (roomName) roomName.classList.add('fullscreen-room-name');
      if (roomActivity) roomActivity.classList.add('fullscreen-room-activity');
      if (digitalClock) digitalClock.classList.add('fullscreen-room-digital');
      if (countdown) countdown.classList.add('fullscreen-room-countdown');
      
      // Resize canvas for fullscreen
      if (canvas) {
        const optimalSize = calculateOptimalClockSize();
        resizeAndRedrawCanvas(canvas, optimalSize);
      }
      
      // Enter fullscreen
      overlay.classList.add('active');
      document.body.classList.add('room-fullscreen-active');
      currentRoomFullscreen = roomId;
      
      // Try to enter browser fullscreen
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(() => {
          console.log('Browser fullscreen failed, using custom fullscreen');
        });
      }
    }

    // Exit room fullscreen mode
    function exitRoomFullscreen() {
      if (!currentRoomFullscreen) return;
      
      const roomId = currentRoomFullscreen;
      const roomElement = document.getElementById(roomId);
      const overlay = document.getElementById('roomFullscreenOverlay');
      
      if (!roomElement) return;
      
      // Get original data
      const originalData = originalRoomData.get(roomId);
      
      // Show the fullscreen button inside the room container again
      const roomButton = roomElement.querySelector('.fs-btn');
      if (roomButton) {
        roomButton.style.display = '';
      }
      
      // Remove the in-fullscreen-mode class
      roomElement.classList.remove('in-fullscreen-mode');
      
      // Remove fullscreen styling
      roomElement.style.position = '';
      roomElement.style.width = '';
      roomElement.style.maxWidth = '';
      roomElement.style.margin = '';
      roomElement.style.padding = '';
      roomElement.style.background = '';
      roomElement.style.border = '';
      roomElement.style.boxShadow = '';
      
      // Remove fullscreen classes
      const roomName = roomElement.querySelector('.room-name');
      const roomActivity = roomElement.querySelector('.room-activity');
      const digitalClock = roomElement.querySelector('.room-digital');
      const countdown = roomElement.querySelector('.room-countdown');
      
      if (roomName) roomName.classList.remove('fullscreen-room-name');
      if (roomActivity) roomActivity.classList.remove('fullscreen-room-activity');
      if (digitalClock) digitalClock.classList.remove('fullscreen-room-digital');
      if (countdown) countdown.classList.remove('fullscreen-room-countdown');
      
      // Move room element back to its original position
      if (originalData && originalData.parent) {
        if (originalData.nextSibling) {
          originalData.parent.insertBefore(roomElement, originalData.nextSibling);
        } else {
          originalData.parent.appendChild(roomElement);
        }
      }
      
      // Reset canvas size
      const canvas = roomElement.querySelector('canvas');
      if (canvas) {
        const canvasId = canvas.id;
        if (originalCanvasData.has(canvasId)) {
          const originalSize = originalCanvasData.get(canvasId);
          resizeAndRedrawCanvas(canvas, originalSize.width);
        } else {
          resizeAndRedrawCanvas(canvas, 300);
        }
      }
      
      // Exit fullscreen
      overlay.classList.remove('active');
      document.body.classList.remove('room-fullscreen-active');
      currentRoomFullscreen = null;
      originalRoomData.delete(roomId);
      
      // Exit browser fullscreen
      if (document.exitFullscreen) {
        document.exitFullscreen().catch(() => {});
      }
    }

    // Exit fullscreen mode for main container
    function exitFullscreenMode() {
      const body = document.body;
      const container = document.getElementById('mainContainer');
      const canvas = document.getElementById('clock');
      const btn = document.getElementById('fullscreenBtn');

      isFullscreen = false;
      body.classList.remove('fullscreen-mode');
      container.classList.remove('fullscreen-mode');
      btn.textContent = '⛶ Fullscreen';

      // Reset canvas size
      if (canvas) {
        if (originalCanvasData.has('clock')) {
          const originalSize = originalCanvasData.get('clock');
          resizeAndRedrawCanvas(canvas, originalSize.width);
        } else {
          resizeAndRedrawCanvas(canvas, 300);
        }
      }

      if (document.exitFullscreen) {
        document.exitFullscreen().catch(() => {});
      }
    }

    // Handle browser fullscreen changes
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        if (isFullscreen) {
          exitFullscreenMode();
        }
        // Exit room fullscreen if active
        if (currentRoomFullscreen) {
          exitRoomFullscreen();
        }
      }
    });

    // Handle escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (currentRoomFullscreen) {
          exitRoomFullscreen();
        } else if (isFullscreen) {
          exitFullscreenMode();
        }
      }
    });

    // Handle window resize
    window.addEventListener('resize', () => {
      if (isFullscreen) {
        const canvas = document.getElementById('clock');
        if (canvas) {
          const size = Math.min(window.innerWidth * 0.6, window.innerHeight * 0.6);
          resizeAndRedrawCanvas(canvas, size);
        }
      }
      
      // Handle room fullscreen resize
      if (currentRoomFullscreen) {
        const roomElement = document.getElementById(currentRoomFullscreen);
        if (roomElement) {
          const canvas = roomElement.querySelector('canvas');
          if (canvas) {
            const optimalSize = calculateOptimalClockSize();
            resizeAndRedrawCanvas(canvas, optimalSize);
          }
        }
      }
    });

    // Setup exit button for room fullscreen
    document.getElementById('roomExitBtn').addEventListener('click', () => {
      if (currentRoomFullscreen) {
        exitRoomFullscreen();
      }
    });

    function updateDigitalClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('en-US', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      // Update main digital clock
      const mainDigital = document.getElementById('digitalClock');
      if (mainDigital) mainDigital.textContent = timeString;
      
      // Update all room digital clocks
      document.querySelectorAll('.room-digital').forEach(el => {
        el.textContent = timeString;
      });
    }

    function drawClockFace(ctx, canvas, radius) {
      try {
        // Clear the entire canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Save the context state
        ctx.save();
        
        // Move to center
        ctx.translate(radius, radius);
        
        // Adjust radius for border
        const actualRadius = radius - 20;
        
        // Draw the outer circle with gradient
        const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, actualRadius);
        gradient.addColorStop(0, '#ffffff');
        gradient.addColorStop(0.7, '#f8fafc');
        gradient.addColorStop(1, '#e2e8f0');
        
        ctx.beginPath();
        ctx.arc(0, 0, actualRadius, 0, 2 * Math.PI);
        ctx.fillStyle = gradient;
        ctx.fill();
        
        // Border
        ctx.strokeStyle = '#cbd5e1';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Inner decorative circles
        ctx.beginPath();
        ctx.arc(0, 0, actualRadius - 15, 0, 2 * Math.PI);
        ctx.strokeStyle = '#e2e8f0';
        ctx.lineWidth = 1;
        ctx.stroke();
        
        // Draw numbers
        drawNumbers(ctx, actualRadius);
        
        // Draw hour markers
        drawMarkers(ctx, actualRadius);
        
        // Draw hands
        drawTime(ctx, actualRadius);
        
        // Draw center dot with gradient
        const centerGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, 8);
        centerGradient.addColorStop(0, '#667eea');
        centerGradient.addColorStop(1, '#764ba2');
        
        ctx.beginPath();
        ctx.arc(0, 0, 8, 0, 2 * Math.PI);
        ctx.fillStyle = centerGradient;
        ctx.fill();
        
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // Restore the context state
        ctx.restore();
      } catch (error) {
        console.error('Error drawing clock:', error);
      }
    }

    function drawNumbers(ctx, radius) {
      const fontSize = Math.max(16, radius / 8);
      ctx.font = `bold ${fontSize}px 'Segoe UI', Arial, sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#1e293b';
      
      for (let num = 1; num <= 12; num++) {
        const angle = (num - 3) * (Math.PI / 6);
        const x = Math.cos(angle) * (radius - 35);
        const y = Math.sin(angle) * (radius - 35);
        ctx.fillText(num.toString(), x, y);
      }
    }

    function drawMarkers(ctx, radius) {
      // Hour markers
      ctx.strokeStyle = '#475569';
      for (let i = 0; i < 12; i++) {
        const angle = i * Math.PI / 6;
        ctx.save();
        ctx.rotate(angle);
        ctx.beginPath();
        ctx.moveTo(0, -(radius - 10));
        ctx.lineTo(0, -(radius - 25));
        ctx.lineWidth = 4;
        ctx.stroke();
        ctx.restore();
      }
      
      // Minute markers
      ctx.strokeStyle = '#94a3b8';
      for (let i = 0; i < 60; i++) {
        if (i % 5 !== 0) {
          const angle = i * Math.PI / 30;
          ctx.save();
          ctx.rotate(angle);
          ctx.beginPath();
          ctx.moveTo(0, -(radius - 10));
          ctx.lineTo(0, -(radius - 18));
          ctx.lineWidth = 1;
          ctx.stroke();
          ctx.restore();
        }
      }
    }

    function drawTime(ctx, radius) {
      const now = new Date();
      const hour = now.getHours() % 12;
      const minute = now.getMinutes();
      const second = now.getSeconds();

      // Hour hand
      const hourAngle = (hour + minute / 60) * Math.PI / 6 - Math.PI / 2;
      drawHand(ctx, hourAngle, radius * 0.5, Math.max(8, radius / 20), '#1e293b');

      // Minute hand
      const minAngle = (minute + second / 60) * Math.PI / 30 - Math.PI / 2;
      drawHand(ctx, minAngle, radius * 0.75, Math.max(6, radius / 25), '#475569');

      // Second hand
      const secAngle = second * Math.PI / 30 - Math.PI / 2;
      drawHand(ctx, secAngle, radius * 0.85, Math.max(2, radius / 60), '#ef4444');
    }

    function drawHand(ctx, angle, length, width, color) {
      ctx.save();
      ctx.strokeStyle = color;
      ctx.lineWidth = width;
      ctx.lineCap = 'round';
      
      // Add shadow for depth
      ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
      ctx.shadowBlur = 2;
      ctx.shadowOffsetX = 1;
      ctx.shadowOffsetY = 1;
      
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(Math.cos(angle) * length, Math.sin(angle) * length);
      ctx.stroke();
      
      ctx.restore();
    }

    function updateActivity() {
      fetch('http://127.0.0.1:5000/current_activity_by_location')
        .then(res => {
          if (!res.ok) {
            throw new Error('Server response not OK');
          }
          return res.json();
        })
        .then(data => {
          const roomsContainer = document.getElementById('rooms');
          
          // Clear existing no-events message
          const existingNoEvents = roomsContainer.querySelector('.no-events');
          if (existingNoEvents) {
            existingNoEvents.remove();
          }

          const entries = Object.entries(data);
          
          if (entries.length === 0) {
            const note = document.createElement('div');
            note.className = 'no-events';
            note.textContent = 'No events scheduled today';
            roomsContainer.appendChild(note);
            return;
          }

          const seen = new Set();
          entries.forEach(([location, item], idx) => {
            const roomId = `room-${idx}`;
            const canvasId = `${roomId}-clock`;
            const digitalId = `${roomId}-digital`;
            const countdownId = `${roomId}-countdown`;
            seen.add(roomId);

            let card = document.getElementById(roomId);
            if (!card) {
              card = document.createElement('div');
              card.id = roomId;
              card.className = 'room-container';
              card.innerHTML = `
                <div class="room-header">
                  <h2 class="room-name"></h2>
                  <button class="fs-btn" onclick="toggleRoomFullscreen('${roomId}')">⛶ Fullscreen</button>
                </div>
                <h3 class="room-activity"></h3>
                <div class="room-content">
                  <canvas class="room-clock" id="${canvasId}" width="300" height="300"></canvas>
                  <div class="room-digital" id="${digitalId}">--:--:--</div>
                  <div class="room-countdown" id="${countdownId}" data-end="">Countdown: --</div>
                </div>
              `;
              roomsContainer.appendChild(card);
              
              // Initialize the clock immediately
              setTimeout(() => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                  // Store original size
                  originalCanvasData.set(canvasId, {
                    width: canvas.width,
                    height: canvas.height
                  });
                  
                  const ctx = canvas.getContext('2d');
                  const radius = canvas.width / 2;
                  
                  // Draw the clock face immediately
                  drawClockFace(ctx, canvas, radius);
                  
                  // Set up interval for continuous updates
                  const interval = setInterval(() => {
                    drawClockFace(ctx, canvas, radius);
                  }, 1000);
                  
                  clockIntervals.set(canvas.id, interval);
                }
              }, 100);
            }

            const nameEl = card.querySelector('.room-name');
            const actEl = card.querySelector('.room-activity');
            const countdownEl = document.getElementById(countdownId);
            
            if (nameEl) nameEl.textContent = location || 'Unassigned Room';
            if (actEl) actEl.textContent = `${item.title} (${item.event_title})`;
            if (countdownEl) countdownEl.setAttribute('data-end', item.end_time || '');
          });

          // Remove any rooms that are no longer active
          const allRooms = roomsContainer.querySelectorAll('.room-container');
          allRooms.forEach(room => {
            if (!seen.has(room.id)) {
              // Clear any intervals for this room's clock
              const canvas = room.querySelector('canvas');
              if (canvas && clockIntervals.has(canvas.id)) {
                clearInterval(clockIntervals.get(canvas.id));
                clockIntervals.delete(canvas.id);
                
                // Remove from original data store
                originalCanvasData.delete(canvas.id);
              }
              room.remove();
            }
          });
        })
        .catch(err => {
          console.error('Failed to fetch activity:', err);
          const activity = document.getElementById("activity");
          if (activity) {
            activity.innerText = "Activity: Connection Error";
            activity.classList.add('status-offline');
          }
        });
    }

    // Update digital clocks and countdowns every second
    function startDigitalUpdates() {
      setInterval(() => {
        updateDigitalClock();
        
        // Update countdowns
        const now = new Date();
        document.querySelectorAll('.room-countdown').forEach(el => {
          const end = el.getAttribute('data-end');
          if (!end) { 
            el.textContent = 'Countdown: --'; 
            return; 
          }
          const endDt = new Date(now.toDateString() + ' ' + end);
          const diff = Math.floor((endDt - now) / 1000);
          
          if (diff > 0) {
            const hours = Math.floor(diff / 3600);
            const mins = Math.floor((diff % 3600) / 60);
            const secs = diff % 60;
            
            // Apply blinking animation if less than 3 minutes remain
            if (diff <= 180) { // 3 minutes = 180 seconds
              el.style.animation = 'blinking 1s infinite';
            } else {
              el.style.animation = 'none';
            }
            
            el.textContent = hours > 0 ? `Ends in: ${hours}h ${mins}m ${secs}s` : `Ends in: ${mins}m ${secs}s`;
            el.classList.remove('status-offline');
          } else {
            const overtime = Math.abs(diff);
            const m = Math.floor(overtime / 60);
            const s = overtime % 60;
            el.textContent = `Overtime: ${m}m ${s}s`;
            el.classList.add('status-offline');
            el.style.animation = 'none';
          }
        });
      }, 1000);
    }

    // Sidebar toggle functionality
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    
    if (menuToggle && sidebar) {
      menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
      });

      // Close sidebar when clicking outside on mobile
      document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768 && 
            !sidebar.contains(e.target) && 
            e.target !== menuToggle) {
          sidebar.classList.remove('active');
        }
      });
    }

    // Listen for real-time updates
    function setupEventStream() {
      const eventSource = new EventSource('http://127.0.0.1:5000/stream');

      eventSource.onmessage = function(event) {
        console.log('Update received:', event.data);
        updateActivity(); // Force refresh current activity
      };

      eventSource.onerror = function(err) {
        console.error('SSE Error:', err);
        setTimeout(setupEventStream, 5000);
        eventSource.close();
      };
    }

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize the activity updates
      updateActivity();
      setInterval(updateActivity, 5000);
      
      // Start digital clock updates
      startDigitalUpdates();
      
      // Start listening for real-time updates
      setupEventStream();
    });

    // Clean up intervals when page unloads
    window.addEventListener('beforeunload', () => {
      clockIntervals.forEach(interval => clearInterval(interval));
      clockIntervals.clear();
    });
  </script>

  <style>
    /* Additional fullscreen styles for moved elements */
    .fullscreen-room-name {
      font-size: clamp(20px, 3.5vw, 28px) !important;
      color: white !important;
      margin-bottom: 15px !important;
      line-height: 1.2;
    }

    .fullscreen-room-activity {
      font-size: clamp(24px, 4.5vw, 36px) !important;
      margin-bottom: 25px !important;
      color: white !important;
      background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6) !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
      background-clip: text !important;
      text-shadow: 0 0 15px rgba(255, 255, 255, 0.3) !important;
      line-height: 1.2;
      font-weight: 700;
    }

    .room-container.fullscreen-mode .room-clock,
    .fullscreen-room-clock {
      width: min(65vw, 55vh) !important;
      height: min(65vw, 55vh) !important;
      margin: 20px auto 25px auto !important;
      background: radial-gradient(circle at 30% 30%, #f8fafc, #cbd5e1) !important;
      border: 10px solid rgba(255, 255, 255, 0.9) !important;
      box-shadow: 
        0 0 30px rgba(255, 255, 255, 0.2),
        inset 0 2px 15px rgba(0, 0, 0, 0.1) !important;
    }

    .fullscreen-room-digital {
      font-size: clamp(20px, 3.5vw, 32px) !important;
      padding: 15px 25px !important;
      margin: 10px auto 15px auto !important;
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(20px) !important;
      border: 2px solid rgba(255, 255, 255, 0.3) !important;
      letter-spacing: 3px !important;
      min-width: 240px !important;
      line-height: 1.2;
      font-weight: 700;
    }

    .fullscreen-room-countdown {
      font-size: clamp(16px, 3vw, 24px) !important;
      padding: 12px 20px !important;
      background: rgba(255, 255, 255, 0.9) !important;
      backdrop-filter: blur(20px) !important;
      border: 2px solid rgba(255, 255, 255, 0.3) !important;
      min-width: 220px !important;
      line-height: 1.3;
      font-weight: 600;
      transition: all 0.3s ease;
    }
  </style>
</body>
</html>