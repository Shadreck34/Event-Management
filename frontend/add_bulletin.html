<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Bulletin - Church Planner</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="stylenew.css">
  <link rel="stylesheet" href="view.css">
  
</head>
<script src="auth.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
    // Check authentication
    if (!AuthService.isAuthenticated()) {
        window.location.href = 'login.html';
        return;
    }

    // Check if user has planner role
    if (!AuthService.hasRole('planner')) {
        showError("You don't have permission to add bulletins");
        window.location.href = 'index.html';
        return;
    }

    eventId = getUrlParam('event_id');
    templateId = getUrlParam('template_id');
    bulletins = [];
    nextOrder = 1;

    if (!eventId) {
        showError("No event ID provided. Please create an event first.");
        document.querySelector('.bulletin-form').style.display = 'none';
        return;
    }

    showMessage(`Initializing bulletin for event ID: ${eventId}`, "info");

    // Load template bulletins if templateId is provided
    if (templateId) {
        await loadTemplateBulletins(templateId);
    } else {
        renderBulletinTable();
    }
});
</script>
<body>
   <div class="dashboard">
        <!-- Mobile Menu Toggle -->
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h2><i class="fas fa-clock"></i> Smart Clock</h2>
    </div>
    <div class="nav-menu">
        <div class="nav-item">
            <a href="index.html" class="nav-link">
                <i class="fas fa-home"></i> Live Dashboard
            </a>
        </div>
        <div class="nav-item">
            <a href="start_planning.html" class="nav-link active">
                <i class="fas fa-calendar-plus"></i> Schedule Event
            </a>
        </div>
        <div class="nav-item">
            <a href="view_plans.html" class="nav-link">
                <i class="fas fa-calendar-alt"></i> View Events
            </a>
        </div>
        <div class="nav-item">
            <a href="templates.html" class="nav-link">
                <i class="fas fa-clone"></i> Event Templates
            </a>
        </div>
        <div class="nav-item">
            <a href="reports.html" class="nav-link">
                <i class="fas fa-chart-bar"></i> Analytics & Reports
            </a>
        </div>
        <div class="nav-item">
            <a href="admin.html" class="nav-link">
                <i class="fas fa-users-cog"></i> Management Panel
            </a>
        </div>
    </div>
</div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1><i class="fas fa-plus-circle"></i> Add Bulletin Items</h1>
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">AD</div>
          <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
          </button>
        </div>
      </div>

      <div id="message"></div>

      <!-- Template Info -->
      <div id="templateInfo" class="alert alert-info" style="display:none;">
        <strong><i class="fas fa-clone"></i> Template Loaded:</strong> 
        <span id="templateName"></span>
        <button onclick="clearTemplate()" class="btn btn-danger btn-sm" style="margin-left:10px;">
          <i class="fas fa-times"></i> Clear Template
        </button>
      </div>

      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-list-ul"></i> Bulletin Items</h2>
        </div>
        <div class="card-body">
          <button class="btn btn-success" onclick="addBulletinItem()">
            <i class="fas fa-plus"></i> Add Item
          </button>
          
          <div class="table-responsive">
            <table class="bulletin-item-table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Duration (min)</th>
                  <th>Preacher</th>
                  <th>Language</th>
                  <th>Category</th>
                  <th>Order</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="bulletinTableBody"></tbody>
            </table>
          </div>
          
          <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="submitBulletins()">
              <i class="fas fa-save"></i> Save Bulletin
            </button>
            <button class="btn btn-secondary" onclick="window.history.back()">
              <i class="fas fa-arrow-left"></i> Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    
    let bulletins = [];
    let nextOrder = 1;
    let eventId = null;
    let templateId = null;
    let loadedTemplateName = '';

    // Just update the showMessage function to use the new alert classes:
    function showMessage(message, type = 'success') {
      const messageDiv = document.getElementById('message');
      const icon = type === 'success' ? 'fa-check-circle' : 
                  type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
      messageDiv.innerHTML = `
        <div class="alert alert-${type}">
          <i class="fas ${icon}"></i> ${message}
        </div>
      `;
      setTimeout(() => messageDiv.innerHTML = '', 5000);
    }
    
    function showError(message) { 
      showMessage(message, 'error'); 
    }

    function addBulletinItem() {
      bulletins.push({
        title: '',
        duration_minutes: 10,
        preacher: '',
        language: 'EN',
        category: '',
        display_order: nextOrder++
      });
      renderBulletinTable();
    }

    function deleteBulletinItem(index) {
      bulletins.splice(index, 1);
      // Re-order remaining items
      bulletins.forEach((item, idx) => {
        item.display_order = idx + 1;
      });
      nextOrder = bulletins.length + 1;
      renderBulletinTable();
    }

    function renderBulletinTable() {
      const tbody = document.getElementById("bulletinTableBody");
      tbody.innerHTML = "";
      bulletins.forEach((item, idx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input value="${item.title || ''}" onchange="updateItem(${idx}, 'title', this.value)" placeholder="Item title" /></td>
          <td><input type="number" value="${item.duration_minutes || 10}" onchange="updateItem(${idx}, 'duration_minutes', this.value)" min="1" /></td>
          <td><input value="${item.preacher || ''}" onchange="updateItem(${idx}, 'preacher', this.value)" placeholder="Preacher name" /></td>
          <td>
            <select onchange="updateItem(${idx}, 'language', this.value)">
              <option value="EN" ${item.language === 'EN' ? 'selected' : ''}>English</option>
              <option value="BEM" ${item.language === 'BEM' ? 'selected' : ''}>Bemba</option>
              <option value="NY" ${item.language === 'NY' ? 'selected' : ''}>Nyanja</option>
            </select>
          </td>
          <td><input value="${item.category || ''}" onchange="updateItem(${idx}, 'category', this.value)" placeholder="Category" /></td>
          <td><input type="number" value="${item.display_order || (idx + 1)}" onchange="updateItem(${idx}, 'display_order', this.value)" min="1" /></td>
          <td><button class="delete-btn" onclick="deleteBulletinItem(${idx})">Delete</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateItem(index, key, value) {
      if (bulletins[index]) {
        bulletins[index][key] = key === 'duration_minutes' || key === 'display_order' ? parseInt(value) : value;
      }
    }

    function clearTemplate() {
      bulletins = [];
      nextOrder = 1;
      loadedTemplateName = '';
      document.getElementById('templateInfo').style.display = 'none';
      renderBulletinTable();
      showMessage("Template cleared. You can now add custom bulletin items.", "info");
    }

    async function loadTemplateBulletins(templateId) {
    try {
        showMessage("Loading template bulletins...", "info");
        
        // First get template details - use authFetch
        const templatesResponse = await authFetch(`${API_BASE}/templates`);
        const templates = await templatesResponse.json();
        const template = templates.find(t => t.id == templateId);
        
        if (template) {
            loadedTemplateName = template.name;
            document.getElementById('templateName').textContent = template.name;
            document.getElementById('templateInfo').style.display = 'block';
        }

        // Load template bulletins - use authFetch
        const response = await authFetch(`${API_BASE}/templates/${templateId}/bulletins`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || "Failed to load template bulletins");
        }

        if (Array.isArray(data) && data.length > 0) {
            bulletins = data.map((item, idx) => ({
                title: item.title || '',
                duration_minutes: item.duration_minutes || 10,
                preacher: item.preacher || '',
                language: item.language || 'EN',
                category: item.category || '',
                display_order: item.display_order || (idx + 1)
            }));
            
            // Set next order number
            nextOrder = bulletins.reduce((max, b) => Math.max(max, b.display_order), 0) + 1;
            
            showMessage(`Template "${loadedTemplateName}" loaded successfully with ${bulletins.length} items!`);
        } else {
            showMessage("Template loaded but contains no bulletin items.", "info");
        }
        
        renderBulletinTable();
    } catch (error) {
        console.error('Template loading error:', error);
        showError(`Failed to load template: ${error.message}`);
        
        // Show template info even if bulletins failed to load
        if (loadedTemplateName) {
            document.getElementById('templateInfo').style.display = 'block';
        }
        
        // Redirect to login if token is missing/invalid
        if (error.message.includes('Token') || error.message.includes('auth')) {
            window.location.href = 'login.html';
        }
    }
}
    async function submitBulletins() {
    if (!eventId) {
        showError("Event ID missing.");
        return;
    }
    if (bulletins.length === 0) {
        showError("Please add at least one bulletin item.");
        return;
    }
    const invalidItems = bulletins.filter(item => !item.title || !item.duration_minutes);
    if (invalidItems.length > 0) {
        showError("Please fill in title and duration for all bulletin items.");
        return;
    }
    try {
        showMessage("Saving bulletins...", "info");
        
        // Use authFetch instead of fetch
        const response = await authFetch(`${API_BASE}/events/${eventId}/bulletins`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(bulletins)
        });
        const result = await response.json();

        // Conflict detection
        if (response.status === 409 && result.conflicts) {
            showConflictOptions(result.conflicts);
            return;
        }

        if (!response.ok) {
            throw new Error(result.error || "Failed to save bulletin.");
        }
        showMessage("Bulletin saved successfully!");
        setTimeout(() => window.location.href = "view_plans.html", 2000);
    } catch (error) {
        console.error('Save error:', error);
        showError(`Failed to save bulletin: ${error.message}`);
        
        // Redirect to login if token is missing/invalid
        if (error.message.includes('Token') || error.message.includes('auth')) {
            window.location.href = 'login.html';
        }
      }
  } 
    function showConflictOptions(conflicts) {
    const modal = document.getElementById('conflictModal');
    modal.innerHTML = '<h2>Conflicting Events Detected</h2>';
    conflicts.forEach(conflict => {
        const conflictDiv = document.createElement('div');
        conflictDiv.textContent = `Conflict with: ${conflict.title} (ID: ${conflict.id})`;
        modal.appendChild(conflictDiv);
    });

    // Option: Change My Event Time
    const changeMineBtn = document.createElement('button');
    changeMineBtn.textContent = "Change My Event Time";
    changeMineBtn.onclick = () => {
        modal.style.display = 'none';
        showMessage("Please adjust your event time and try again.", "info");
    };

    // Option: Change Conflicting Event Time
    const changeOtherBtn = document.createElement('button');
    changeOtherBtn.textContent = "Change Conflicting Event Time";
    changeOtherBtn.onclick = () => {
        modal.style.display = 'none';
        // Redirect to edit page for the first conflicting event
        window.location.href = `edit_event.html?event_id=${conflicts[0].id}`;
    };

    // Option: Keep My Event (Delete Conflicting) - using authFetch
    const keepMineBtn = document.createElement('button');
    keepMineBtn.textContent = "Keep My Event (Delete Conflicting)";
    keepMineBtn.onclick = async () => {
        try {
            for (const conflict of conflicts) {
                await authFetch(`${API_BASE}/events/${conflict.id}`, { 
                    method: "DELETE" 
                });
            }
            modal.style.display = 'none';
            submitBulletins(); // Retry saving
        } catch (error) {
            console.error('Delete conflict error:', error);
            showError(`Failed to resolve conflict: ${error.message}`);
        }
    };

    modal.appendChild(changeMineBtn);
    modal.appendChild(changeOtherBtn);
    modal.appendChild(keepMineBtn);
    modal.style.display = 'block';
}
    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // Make functions globally available
    window.updateItem = updateItem;
    window.deleteBulletinItem = deleteBulletinItem;
    window.addBulletinItem = addBulletinItem;
    window.submitBulletins = submitBulletins;
    window.clearTemplate = clearTemplate;

    // Page initialization
    document.addEventListener('DOMContentLoaded', async () => {
      eventId = getUrlParam('event_id');
      templateId = getUrlParam('template_id');
      bulletins = [];
      nextOrder = 1;

      if (!eventId) {
        showError("No event ID provided. Please create an event first.");
        document.querySelector('.bulletin-form').style.display = 'none';
        return;
      }

      showMessage(`Initializing bulletin for event ID: ${eventId}`, "info");

      // Load template bulletins if templateId is provided
      if (templateId) {
        await loadTemplateBulletins(templateId);
      } else {
        renderBulletinTable();
      }
    });
    // Mobile menu toggle
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    e.target !== menuToggle) {
                    sidebar.classList.remove('active');
                }
            });
  </script>
</body>
</html>