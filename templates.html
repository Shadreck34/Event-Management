<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Templates - Church Planner</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<script src="auth.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Check authentication
        if (!AuthService.isAuthenticated()) {
            window.location.href = 'login.html';
            return;
        }

        // Example: restrict to planners
        if (!AuthService.hasRole('admin')) {
            window.location.href = 'index.html';
        }

        

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', () => {
            AuthService.logout();
        });
    });
</script>
<body>
  <div class="dashboard">
        <!-- Mobile Menu Toggle -->
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h2><i class="fas fa-clock"></i> Smart Clock</h2>
    </div>
    <div class="nav-menu">
        <div class="nav-item">
            <a href="index.html" class="nav-link">
                <i class="fas fa-home"></i> Live Dashboard
            </a>
        </div>
        <div class="nav-item">
            <a href="start_planning.html" class="nav-link">
                <i class="fas fa-calendar-plus"></i> Schedule Event
            </a>
        </div>
        <div class="nav-item">
            <a href="view_plans.html" class="nav-link">
                <i class="fas fa-calendar-alt"></i> View Events
            </a>
        </div>
        <div class="nav-item">
            <a href="templates.html" class="nav-link active">
                <i class="fas fa-clone"></i> Event Templates
            </a>
        </div>
        <div class="nav-item">
            <a href="reports.html" class="nav-link">
                <i class="fas fa-chart-bar"></i> Analytics & Reports
            </a>
        </div>
        <div class="nav-item">
            <a href="admin.html" class="nav-link">
                <i class="fas fa-users-cog"></i> User Management
            </a>
        </div>
    </div>
</div>
    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1><i class="fas fa-clone"></i> Bulletin Templates</h1>
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">AD</div>
          <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
          </button>
        </div>
      </div>

      <div id="message"></div>

      <button class="btn btn-success" onclick="protectedAction('create', showTemplateForm)" data-role-required="planner">
        <i class="fas fa-plus"></i> Create New Template
      </button>

      <!-- Template Form -->
      <div id="templateForm" class="card template-form hidden">
        <div class="card-header">
          <h2 id="templateFormHeader"><i class="fas fa-clone"></i> Create Template</h2>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="templateName"><i class="fas fa-heading"></i> Template Name</label>
            <input type="text" id="templateName" class="form-control" placeholder="e.g. Sunday Service Template">
          </div>
          <div class="form-group">
            <label for="templateDescription"><i class="fas fa-align-left"></i> Description</label>
            <textarea id="templateDescription" class="form-control" rows="3" placeholder="Description of this template"></textarea>
          </div>
        </div>

        <div class="template-items">
          <div class="card-header">
            <h2><i class="fas fa-list-ul"></i> Template Items</h2>
          </div>
          <button class="btn btn-success" onclick="addTemplateItem()" data-role-required="planner">
            <i class="fas fa-plus"></i> Add Item
          </button>
          
          <div class="table-responsive">
            <table class="bulletin-item-table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Duration (min)</th>
                  <th>Preacher</th>
                  <th>Language</th>
                  <th>Category</th>
                  <th>Order</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="templateItemsBody"></tbody>
            </table>
          </div>
          
          <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="protectedAction('update', saveTemplate)" data-role-required="planner">
              <i class="fas fa-save"></i> Save Template
            </button>
            <button class="btn btn-secondary" onclick="cancelTemplate()">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Templates List -->
      <div id="templatesContainer" class="card">
        <div class="card-header">
          <h2><i class="fas fa-list"></i> Existing Templates</h2>
        </div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="templatesTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Template View -->
      <div id="templateView" class="card template-form hidden">
        <div class="card-header">
          <h2 id="templateViewHeader"><i class="fas fa-eye"></i> Template Details</h2>
        </div>
        <div id="templateViewDescription" class="card-body"></div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Title</th>
                <th>Duration</th>
                <th>Preacher</th>
                <th>Language</th>
                <th>Category</th>
              </tr>
            </thead>
            <tbody id="templateViewItems"></tbody>
          </table>
        </div>
        <button class="btn btn-secondary" onclick="hideTemplateView()">
          <i class="fas fa-arrow-left"></i> Back to Templates
        </button>
      </div>
    </div>
  </div>
  <script>
    
    let templateItems = [];
    let nextOrder = 1;
    let editTemplateId = null;

    function showMessage(message, type = 'success') {
      const messageDiv = document.getElementById('message');
      const icon = type === 'success' ? 'fa-check-circle' : 
                  type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
      messageDiv.innerHTML = `
        <div class="alert alert-${type}">
          <i class="fas ${icon}"></i> ${message}
        </div>
      `;
      setTimeout(() => messageDiv.innerHTML = '', 5000);
    }
    function showError(message) { showMessage(message, 'error'); }

    async function apiCall(url, options = {}) {
      try {
        const response = await authFetch(url, {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || `HTTP ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    function showTemplateForm(isEdit = false) {
      document.getElementById('templateForm').classList.remove('hidden');
      document.getElementById('templatesContainer').classList.add('hidden');
      document.getElementById('templateView').classList.add('hidden');
      document.getElementById('templateFormHeader').innerText = isEdit ? "Edit Template" : "Create Template";
      if (!isEdit) resetTemplateForm();
    }

    function hideTemplateForm() {
      document.getElementById('templateForm').classList.add('hidden');
      document.getElementById('templatesContainer').classList.remove('hidden');
      editTemplateId = null;
    }

    function hideTemplateView() {
      document.getElementById('templateView').classList.add('hidden');
      document.getElementById('templatesContainer').classList.remove('hidden');
    }

    function resetTemplateForm() {
      document.getElementById('templateName').value = '';
      document.getElementById('templateDescription').value = '';
      templateItems = [];
      nextOrder = 1;
      editTemplateId = null;
      renderTemplateItems();
    }

    function addTemplateItem() {
      templateItems.push({
        title: '',
        duration_minutes: 10,
        preacher: '',
        language: 'EN',
        category: '',
        display_order: nextOrder++
      });
      renderTemplateItems();
    }

    function deleteTemplateItem(index) {
      templateItems.splice(index, 1);
      renderTemplateItems();
    }

    function renderTemplateItems() {
      const tbody = document.getElementById('templateItemsBody');
      tbody.innerHTML = '';
      templateItems.forEach((item, idx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input value="${item.title || ''}" onchange="updateTemplateItem(${idx}, 'title', this.value)" placeholder="Item title" /></td>
          <td><input type="number" value="${item.duration_minutes || 10}" onchange="updateTemplateItem(${idx}, 'duration_minutes', this.value)" min="1" /></td>
          <td><input value="${item.preacher || ''}" onchange="updateTemplateItem(${idx}, 'preacher', this.value)" placeholder="Preacher name" /></td>
          <td>
            <select onchange="updateTemplateItem(${idx}, 'language', this.value)">
              <option value="EN" ${item.language === 'EN' ? 'selected' : ''}>English</option>
              <option value="BEM" ${item.language === 'BEM' ? 'selected' : ''}>Bemba</option>
              <option value="NY" ${item.language === 'NY' ? 'selected' : ''}>Nyanja</option>
            </select>
          </td>
          <td><input value="${item.category || ''}" onchange="updateTemplateItem(${idx}, 'category', this.value)" placeholder="Category" /></td>
          <td><input type="number" value="${item.display_order || (idx + 1)}" onchange="updateTemplateItem(${idx}, 'display_order', this.value)" min="1" /></td>
          <td><button class="delete-btn" onclick="deleteTemplateItem(${idx})">Delete</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateTemplateItem(index, key, value) {
      if (templateItems[index]) {
        templateItems[index][key] = key === 'duration_minutes' || key === 'display_order' ? parseInt(value) : value;
      }
    }

    async function saveTemplate() {
      const name = document.getElementById('templateName').value;
      const description = document.getElementById('templateDescription').value;

      if (!name) {
        showError('Please enter a template name');
        return;
      }
      if (templateItems.length === 0) {
        showError('Please add at least one template item');
        return;
      }
      const invalidItems = templateItems.filter(item => !item.title || !item.duration_minutes);
      if (invalidItems.length > 0) {
        showError('Please fill in title and duration for all template items');
        return;
      }

      try {
        const templateData = {
          name,
          description,
          bulletins: templateItems
        };

        if (editTemplateId) {
          // Update existing template
          await apiCall(`${API_BASE}/templates/${editTemplateId}`, {
            method: 'PUT',
            body: JSON.stringify(templateData)
          });
          showMessage('Template updated successfully!');
        } else {
          // Create new template
          await apiCall(`${API_BASE}/templates`, {
            method: 'POST',
            body: JSON.stringify(templateData)
          });
          showMessage('Template saved successfully!');
        }
        hideTemplateForm();
        loadTemplates();
      } catch (error) {
        showError(`Failed to save template: ${error.message}`);
      }
    }

    function cancelTemplate() {
      hideTemplateForm();
    }

    async function loadTemplates() {
      try {
        const templates = await apiCall(`${API_BASE}/templates`);
        const tbody = document.getElementById('templatesTableBody');
        tbody.innerHTML = '';

        if (templates.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="no-templates">No templates found. Create your first template above.</td></tr>';
          return;
        }

        templates.forEach(template => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${template.name}</td>
            <td>${template.description || '-'}</td>
            <td>
              <button class="view-btn" onclick="viewTemplate(${template.id}, '${template.name}', '${template.description || ''}')">View</button>
              <button class="edit-btn" onclick="editTemplate(${template.id})">Edit</button>
              <button class="delete-btn" onclick="deleteTemplate(${template.id}, '${template.name}')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        showError(`Failed to load templates: ${error.message}`);
      }
    }

    async function viewTemplate(templateId, templateName, templateDescription) {
      try {
        const items = await apiCall(`${API_BASE}/templates/${templateId}/bulletins`);
        document.getElementById('templateViewHeader').innerText = `Template: ${templateName}`;
        document.getElementById('templateViewDescription').innerHTML = templateDescription ? `<p><strong>Description:</strong> ${templateDescription}</p>` : '';
        const tbody = document.getElementById('templateViewItems');
        tbody.innerHTML = '';
        if (items.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="no-templates">No items in this template.</td></tr>';
        } else {
          items.forEach((item, i) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${i + 1}</td>
              <td>${item.title}</td>
              <td>${item.duration_minutes} min</td>
              <td>${item.preacher || '-'}</td>
              <td>${item.language || 'EN'}</td>
              <td>${item.category || '-'}</td>
            `;
            tbody.appendChild(row);
          });
        }
        document.getElementById('templateView').classList.remove('hidden');
        document.getElementById('templatesContainer').classList.add('hidden');
        document.getElementById('templateForm').classList.add('hidden');
      } catch (error) {
        showError(`Failed to load template: ${error.message}`);
      }
    }

    async function editTemplate(templateId) {
      try {
        // Get template details
        const templates = await apiCall(`${API_BASE}/templates`);
        const template = templates.find(t => t.id === templateId);
        if (!template) {
          showError('Template not found');
          return;
        }
        document.getElementById('templateName').value = template.name;
        document.getElementById('templateDescription').value = template.description || '';
        // Get template bulletins
        const items = await apiCall(`${API_BASE}/templates/${templateId}/bulletins`);
        templateItems = items.map((item, idx) => ({
          title: item.title || '',
          duration_minutes: item.duration_minutes || 10,
          preacher: item.preacher || '',
          language: item.language || 'EN',
          category: item.category || '',
          display_order: item.display_order || (idx + 1)
        }));
        nextOrder = templateItems.reduce((max, b) => Math.max(max, b.display_order), 0) + 1;
        editTemplateId = templateId;
        renderTemplateItems();
        showTemplateForm(true);
      } catch (error) {
        showError('Failed to load template for editing');
      }
    }

    async function deleteTemplate(templateId, templateName) {
      if (!confirm(`Are you sure you want to delete the template "${templateName}"?`)) {
        return;
      }
      try {
        await apiCall(`${API_BASE}/templates/${templateId}`, {
          method: 'DELETE'
        });
        showMessage(`Template "${templateName}" deleted successfully!`);
        loadTemplates();
      } catch (error) {
        showError(`Failed to delete template: ${error.message}`);
      }
    }
    // Mobile menu toggle
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    e.target !== menuToggle) {
                    sidebar.classList.remove('active');
                }
            });
            document.getElementById('logoutBtn').addEventListener('click', () => {
  // Add your logout logic here
  // For example: AuthService.logout();
  window.location.href = 'login.html';
});
            
    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      loadTemplates();
      hideTemplateForm();
      hideTemplateView();
    });
  </script>
</body>
</html>